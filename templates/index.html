<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Load Roboto Mono font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: monospace;
    }
    /* Main background area */
    #main {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      background-size: cover;
      background-position: center center;
    }
    /* Menu with dashed border and light grey background */
    .menu {
      position: fixed;
      top: 2vh;
      right: 2vh;
      width: 300px;
      max-height: 90vh;
      background-color: #f9f9f9; /* Light wash grey */
      border: 3px dashed #0C3A81;
      padding: 10px;
      border-radius: 20px;
      overflow-y: auto;
    }
    /* Step bar styling */
    .step-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      margin-top: 10px;
    }
    .step-bar div {
      background-color: #ddd;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .step-bar div:hover {
      background-color: #ffe5e5;
    }
    .step-bar .active {
      background-color: #0C3A81;
      color: #fff;
    }
    /* Layout section with left-aligned heading */
    .layout-section {
      margin-bottom: 20px;
    }
    .layout-section p {
      margin: 0;
      font-size: 1.7em;
      font-weight: bold;
      margin-bottom: 15px;
      margin-top: 25px;
      text-align: left;
    }
    /* Group for sliders and preview button */
    .sliders-box {
      border: 2px solid #0C3A81;
      padding: 20px;
      border-radius: 20px;
    }
    .slider-label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      text-align: left;
      font-size: 15px;
    }
    .slider-input {
      width: 100%;
      margin-bottom: 10px;
      /* Remove default appearance */
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
    }
    /* Custom slider styling for WebKit */
    .slider-input::-webkit-slider-runnable-track {
      background: #f2cfcf;
      height: 4px;
      border-radius: 2px;
    }
    .slider-input::-webkit-slider-thumb {
      width: 14px;
      height: 14px;
      background: #ffffff; /* White thumb */
      border-radius: 50%;
      cursor: pointer;
      margin-top: -5px;
    }
    /* For Firefox */
    .slider-input::-moz-range-track {
      background: #f2cfcf;
      height: 4px;
      border-radius: 2px;
    }
    .slider-input::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #ffffff; /* White thumb */
      border-radius: 50%;
      cursor: pointer;
    }
    /* Preview button (centered, transparent fill, muted red border) */
    .preview-btn {
      background-color: transparent;
      border: 2px solid #cc6666;
      color: #cc6666;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      display: block;
      margin: 10px auto 0 auto;
      transition: background-color 0.2s;
      font-family: monospace;
    }
    .preview-btn:hover {
      background-color: #ffe5e5;
    }
    /* Navigation buttons: Next above Previous, both transparent */
    .nav-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 5px;
    }
    .nav-buttons button {
      /* type="button" to prevent accidental form submission */
      background-color: transparent;
      border-radius: 20px;
      cursor: pointer;
      padding: 8px 16px;
      transition: background-color 0.2s;
      font-family: monospace;
    }
    .nav-buttons .next-button {
      border: 2px solid #cc6666;
      color: #cc6666;
    }
    .nav-buttons .next-button:hover {
      background-color: #ffe5e5;
    }
    .nav-buttons .prev-button {
      border: none;
      color: #cc6666;
    }
    .nav-buttons .prev-button:hover {
      background-color: #ffe5e5;
    }
  </style>
</head>
<body>
  <!-- Main background area -->
  <div id="main"></div>
  
  <!-- Menu (right side) -->
  <div class="menu">
    <!-- Step bar: clicking a step posts room data -->
    <div class="step-bar">
      <div class="step-btn active" data-step="1">1</div>
      <div class="step-btn" data-step="2">2</div>
      <div class="step-btn" data-step="3">3</div>
      <div class="step-btn" data-step="4">4</div>
      <div class="step-btn" data-step="5">5</div>
      <div class="step-btn" data-step="6">6</div>
      <div class="step-btn" data-step="Store">Store</div>
    </div>
    
    <!-- Layout section: grouped sliders & centered Preview button for configuration -->
    <div class="layout-section">
      <p>Layout</p>
      <div class="sliders-box">
        <label class="slider-label" for="config_x_range">
          Corridor Width: <span id="config_x_value">1</span> ft
        </label>
        <input class="slider-input" type="range" min="1" max="3" value="1" step="0.1" name="config_x_range" id="config_x_range">
        <br><br>
        <label class="slider-label" for="config_y_range">
          Rack Width: <span id="config_y_value">1</span> ft
        </label>
        <input class="slider-input" type="range" min="1" max="3" value="1" step="0.1" name="config_y_range" id="config_y_range">
        <button type="button" class="preview-btn">Preview</button>
      </div>
    </div>
    
    <!-- Navigation buttons: Next and Previous navigate pages -->
    <div class="nav-buttons">
      <button type="button" class="next-button">Next</button>
      <button type="button" class="prev-button">Previous</button>
    </div>
  </div>
  
  <script>
    window.onload = function() {
      const main = document.getElementById("main");
      // Declare image_path once (this may come from your server template)
      let image_path = '{{ image_path }}';
      
      // Set the initial background image
      if (!image_path || image_path === 'None') {
        main.style.background = 'linear-gradient(45deg, #FE6B8B 30%, #FF8E53 90%)';
      } else {
        const timestamp = new Date().getTime();
        main.style.backgroundImage = `url('${image_path}?t=${timestamp}')`;
      }
      
      // Function to update the background image with a cache-busting parameter
      function updateBackgroundImage() {
        const timestamp = new Date().getTime();
        main.style.backgroundImage = `url('${image_path}?t=${timestamp}')`;
      }
      
      // Slider elements for configuration
      const configXSlider = document.getElementById("config_x_range");
      const configYSlider = document.getElementById("config_y_range");
      const configXValueDisplay = document.getElementById("config_x_value");
      const configYValueDisplay = document.getElementById("config_y_value");
      
      // Update slider display values as sliders move
      configXSlider.addEventListener("input", () => {
        configXValueDisplay.textContent = parseFloat(configXSlider.value).toFixed(1);
      });
      configYSlider.addEventListener("input", () => {
        configYValueDisplay.textContent = parseFloat(configYSlider.value).toFixed(1);
      });
      
      // Helper function: send POST (always returns a promise)
      function postData(data) {
        const formData = new URLSearchParams(data);
        return fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData
        })
        .then(response => response.text())
        .then(responseText => {
          console.log("Server response:", responseText);
          return responseText;
        })
        .catch(error => {
          console.error("Error posting data:", error);
          return Promise.reject(error);
        });
      }
      
      // Step bar: clicking a step posts room data (simulate the room form)
      const stepButtons = document.querySelectorAll('.step-btn');
        stepButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            stepButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const roomValue = btn.getAttribute('data-step');
            console.log("Posting room data:", { room_x_range: roomValue, data_type: 'room' });
            postData({ room_x_range: roomValue, data_type: 'room' })
            .then(responseText => {
                console.log("Room data saved. Server responded:", responseText);
            })
            .catch(error => console.error("Error posting room data:", error));
        });
        });
      
      // Navigation buttons: these now navigate to different pages
      const nextButton = document.querySelector('.next-button');
      const prevButton = document.querySelector('.prev-button');
      
      nextButton.addEventListener('click', (e) => {
        e.preventDefault();
        // Navigate to the next page (adjust URL as needed)
        window.location.href = '/next';
      });
      
      prevButton.addEventListener('click', (e) => {
        e.preventDefault();
        // Navigate to the previous page (adjust URL as needed)
        window.location.href = '/prev';
      });
      
      // Preview button: posts configuration data and then updates the background image
      const previewButton = document.querySelector('.preview-btn');
      previewButton.addEventListener('click', (e) => {
        e.preventDefault();
        let corridorWidth = configXSlider.value;
        let rackWidth = configYSlider.value;
        
        // Update display values
        configXSlider.value = corridorWidth;
        configXValueDisplay.textContent = parseFloat(corridorWidth).toFixed(1);
        configYSlider.value = rackWidth;
        configYValueDisplay.textContent = parseFloat(rackWidth).toFixed(1);
        
        // Post config data and then update background image
        postData({ config_x_range: corridorWidth, config_y_range: rackWidth })
          .then(() => {
            updateBackgroundImage();
          })
          .catch(error => console.error("Error posting config data:", error));
      });
      
      // Load previous form data if available (to restore slider values and active step)
      try {
        let form_data = JSON.parse('{{ form_data | tojson }}');
        if (form_data) {
          if (form_data.config_x_range !== undefined) {
            configXSlider.value = form_data.config_x_range;
            configXValueDisplay.textContent = parseFloat(form_data.config_x_range).toFixed(1);
          }
          if (form_data.config_y_range !== undefined) {
            configYSlider.value = form_data.config_y_range;
            configYValueDisplay.textContent = parseFloat(form_data.config_y_range).toFixed(1);
          }
          if (form_data.room_x_range !== undefined) {
            stepButtons.forEach(b => {
              if (b.getAttribute('data-step') == form_data.room_x_range) {
                stepButtons.forEach(btn => btn.classList.remove('active'));
                b.classList.add('active');
              }
            });
          }
        }
      } catch (error) {
        console.warn("Error parsing form data:", error);
      }
    };
  </script>
</body>
</html>